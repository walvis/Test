<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Test : testing">

    <link rel="stylesheet" href="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/themes/css/cartodb.css" />
	<link rel="stylesheet" href="javascripts/leaflet-search.css" />
	<script src="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/cartodb.js"></script>
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA8R88QEi9kUJS4dBThpgNkplhJDXMV518&v=3&libraries=places&sensor=false"></script>
	<script src="javascripts/leaflet-search.js"></script>
	<!--[if lte IE 8]>
    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v2/themes/css/cartodb.ie.css" />
	<![endif]-->
	<style>
    html, body {width:100%; height:100%; padding: 0; margin: 0;}
    #cartodb-map { width: 100%; height:100%; background: black;}
	</style>

    <title>Test</title>
	<script>
    var map;
    function init(){
      // initiate leaflet map
      map = new L.Map('cartodb-map', { 
        center: [32.8,-117],
        zoom: 12
      })
	  	  
	   L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);
	  
	  //var layerUrl = 'https://walvis.carto.com/api/v2/viz/47b29da2-62ee-11e6-ad18-0ee66e2c9693/viz.json';
	  
	  //cartodb.createLayer(map, layerUrl)
	  //	.addTo(map)
	  //	.on('done', function(layer) {
	  //}).on('error', function() {
	  //log the error
	  //});
	  
	  // Initialise the FeatureGroup to store editable layers
		var drawnItems = new L.FeatureGroup();
		var geojsonMarkerOptions = {
			radius: 5,
			fillColor: "#7AB800",
			color: "#000",
			weight: 1,
			opacity: 1,
			fillOpacity: 0.8
		};
		//Add previous data
		var url = "https://walvis.carto.com/api/v2/sql?format=geojson&q=SELECT cartodb_id,the_geom FROM table_4sranch_geocode_3_11_2016_xy";
		$.getJSON(url, function(data) {
			geojsonLayer = L.geoJson(data, {
				pointToLayer: function (feature, latlng) {
					return new L.circleMarker(latlng, geojsonMarkerOptions);
				},
				onEachFeature: function(feature, layer) {
					layer.cartodb_id = feature.properties.cartodb_id;
					layer.bindPopup("Hello World");
					drawnItems.addLayer(layer);					
				}
				
			});
			
			map.addLayer(drawnItems);
		});
	 
	 
	 //Search
	 var geocoder = new google.maps.Geocoder();
	 function googleGeocoding(text, callResponse)
	{
		geocoder.geocode({address: text}, callResponse);
	}
	function formatJSON(rawjson)
	{
		var json = {},
			key, loc, disp = [];
		for(var i in rawjson)
		{
			key = rawjson[i].formatted_address;
			loc = L.latLng( rawjson[i].geometry.location.lat(), rawjson[i].geometry.location.lng() );
			json[ key ]= loc;	//key,value format
		}
		return json;
	}
	
	map.addControl( new L.Control.Search({
			sourceData: googleGeocoding,
			formatData: formatJSON,
			markerLocation: true,
			autoType: true,
			autoCollapse: true,
			minLength: 2
		}) );

    }
  </script>
  </head>

  <body onload="init()">
  <div id='cartodb-map'></div>
  </body>
</html>
