<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Test : testing">

    <link rel="stylesheet" href="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/themes/css/cartodb.css" />
	<link rel="stylesheet" href="javascripts/leaflet-search.css" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.3.2/leaflet.draw.css" />
	<script src="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/cartodb.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.3.2/leaflet.draw.js"></script>
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA8R88QEi9kUJS4dBThpgNkplhJDXMV518&v=3&libraries=places&sensor=false"></script>
	<script src="javascripts/leaflet-search.js"></script>
	<!--[if lte IE 8]>
    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v2/themes/css/cartodb.ie.css" />
	<![endif]-->
	<style>
    html, body {width:100%; height:100%; padding: 0; margin: 0;}
    #cartodb-map { width: 100%; height:100%; background: black;}
	</style>

    <title>Test</title>
	<script>
    var map;
    function init(){
      // initiate leaflet map
      map = new L.Map('cartodb-map', { 
        center: [32.8,-117],
        zoom: 12
      })
	  	  
	   L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);
	  
	  //var layerUrl = 'https://walvis.carto.com/api/v2/viz/47b29da2-62ee-11e6-ad18-0ee66e2c9693/viz.json';
	  
	  //cartodb.createLayer(map, layerUrl)
	  //	.addTo(map)
	  //	.on('done', function(layer) {
	  //}).on('error', function() {
	  //log the error
	  //});
	  
	  // Initialise the FeatureGroup to store editable layers
		var drawnItems = new L.FeatureGroup();
		var geojsonMarkerOptions = {
			radius: 5,
			fillColor: "#7AB800",
			color: "#000",
			weight: 1,
			opacity: 1,
			fillOpacity: 0.7
		};
		//Add previous data
		var url = "https://walvis.carto.com/api/v2/sql?format=geojson&q=SELECT cartodb_id,the_geom,street_nm,house_ FROM table_4sranch_geocode_3_11_2016_xy";
		$.getJSON(url, function(data) {
			geojsonLayer = L.geoJson(data, {
				pointToLayer: function (feature, latlng) {
					return new L.circleMarker(latlng, geojsonMarkerOptions);
				},
				onEachFeature: function(feature, layer) {
					layer.cartodb_id = feature.properties.cartodb_id;
					layer.bindPopup(feature.properties.house_ + " " + feature.properties.street_nm);
					drawnItems.addLayer(layer);					
				}
				
			});
			
			map.addLayer(drawnItems);
			
			// Initialise the draw control and pass it the FeatureGroup of editable layers
			var drawControl = new L.Control.Draw({
				edit: {
					featureGroup: drawnItems
				}
			});

			map.addControl(drawControl);
			
			//SQL insert/update/delete
			
			map.on('draw:created', function(e) {
				drawnItems.addLayer(e.layer);
				persistOnCartoDB("INSERT", e.layer);
			});
			map.on('draw:edited', function(e) {
				persistOnCartoDB("UPDATE", e.layers);
			});
			map.on('draw:deleted', function(e) {
				persistOnCartoDB("DELETE", e.layers);
			});
			function persistOnCartoDB(action, layers) {
				var cartodb_ids = [];
				var geojsons = [];
				switch (action) {
					case "UPDATE":
						if (layers.getLayers().length < 1) return;
						layers.eachLayer(function(layer) {
							cartodb_ids.push(layer.cartodb_id);
							geojsons.push("'" + JSON.stringify(layer.toGeoJSON()) + "'");
						});
						break;
					case "INSERT":
						cartodb_ids.push(-1);
						geojsons.push("'" + JSON.stringify(layers.toGeoJSON()) + "'");
						break;
					case "DELETE":
						layers.eachLayer(function(layer) {
							cartodb_ids.push(layer.cartodb_id);
							geojsons.push("''");
						});
						break;
				}
				var sql = "SELECT table_4sranch_geocode_3_11_2016_xy(ARRAY[";
				sql += cartodb_ids.join(",");
				sql += "],ARRAY[";
				sql += geojsons.join(",");
				sql += "]);";
				console.log("persisting... https://walvis.carto.com/api/v2/sql?q=" + sql);
				$.ajax({
					type: 'POST',
					url: 'https://walvis.carto.com/api/v2/sql',
					crossDomain: true,
					data: {
						"q": sql
					},
					dataType: 'json',
					success: function(responseData, textStatus, jqXHR) {
						console.log("Data saved");
						if (action == "INSERT")
							layers.cartodb_id = responseData.rows[0].cartodb_id;
					},
					error: function(responseData, textStatus, errorThrown) {
						console.log("Problem saving the data");
						console.log(responseData);
						console.log(textStatus);
						console.log(errorThrown);
					}
				});
			}
			
		});
	 
	 
	 //Search
	 var geocoder = new google.maps.Geocoder();
	 function googleGeocoding(text, callResponse)
	{
		geocoder.geocode({address: text}, callResponse);
	}
	function formatJSON(rawjson)
	{
		var json = {},
			key, loc, disp = [];
		for(var i in rawjson)
		{
			key = rawjson[i].formatted_address;
			loc = L.latLng( rawjson[i].geometry.location.lat(), rawjson[i].geometry.location.lng() );
			json[ key ]= loc;	//key,value format
		}
		return json;
	}
	
	map.addControl( new L.Control.Search({
			sourceData: googleGeocoding,
			formatData: formatJSON,
			markerLocation: true,
			autoType: true,
			autoCollapse: true,
			minLength: 2
		}) );
	//End Search

    }
  </script>
  </head>

  <body onload="init()">
  <div id='cartodb-map'></div>
  </body>
</html>
